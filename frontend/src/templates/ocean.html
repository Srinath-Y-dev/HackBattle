<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fin-Ocean: Your Savings Vessel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #87CEEB; 
            overflow: hidden; 
        }
        
        #oceanCanvas {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            outline: none; 
            z-index: 5;
            cursor: grab;
        }
        
        #oceanCanvas:active {
            cursor: grabbing;
        }
        
        .boat-clickable { cursor: pointer !important; }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .transaction-item { animation: fadeInDown 0.5s ease-out forwards; }
        
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .modal-hidden { pointer-events: none; opacity: 0; }
        .modal-hidden .modal-content { transform: translateY(20px); }

        .ghost-timeline { opacity: 0.6; border: 1px dashed #004d40; }

        .progress-bar-container { background-color: rgba(255, 255, 255, 0.3); }
        .progress-bar { transition: width 0.5s ease-out; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 10px 10px rgba(46, 204, 113, 0); }
        }
        .upgrade-boat-btn { animation: pulse 2s infinite; }
        
        @keyframes score-pop {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            50% { transform: translateY(-15px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1); opacity: 0; }
        }
        .score-change {
            position: absolute;
            top: 5px;
            right: -5px;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 4px;
            opacity: 0;
        }
        .score-change.show {
            animation: score-pop 1.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-[#87CEEB]">

    <main class="relative h-screen w-full overflow-hidden">
        
        <section id="boat-section" class="absolute inset-0">
            <canvas id="oceanCanvas"></canvas>
        </section>

        <header class="absolute top-0 left-0 right-0 p-6 flex justify-between items-start text-white z-20">
            <button id="balanceLockerBtn" class="flex items-center space-x-3 bg-black/20 backdrop-blur-sm p-2 rounded-lg transition-transform hover:scale-105">
                <i class="fas fa-treasure-chest text-amber-300 text-2xl"></i>
                <div>
                    <p class="text-xs opacity-80 text-left">Total Balance</p>
                    <h1 class="text-lg font-bold monetary-value" data-amount="124580.75">₹1,24,580.75</h1>
                </div>
            </button>
            
            <div id="savings-ui-container" class="w-full max-w-xs bg-black/20 backdrop-blur-sm rounded-lg p-3 z-20">
                <p class="text-white text-sm font-medium text-right">This Month's Savings Goal</p>
                <div class="text-white text-lg font-bold tracking-tight text-right">
                    <span class="monetary-value" data-amount="0" id="currentSavings">₹0.00</span> / 
                    <span class="monetary-value" data-amount="15000" id="savingsGoal">₹15,000.00</span>
                </div>
                <div class="w-full progress-bar-container rounded-full h-2.5 mt-2">
                  <div id="savingsProgressBar" class="bg-[#ee9b00] h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <div id="velocityScoreGauge" class="absolute top-24 left-6 w-24 h-12 cursor-pointer z-20 flex flex-col items-center justify-end">
             <svg viewBox="0 0 100 50" class="w-full h-auto">
                <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#fff" stroke-width="10" stroke-linecap="round" opacity="0.3"/>
                <path id="velocityScoreBar" d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#ee9b00" stroke-width="10" stroke-linecap="round" stroke-dasharray="125.6" stroke-dashoffset="125.6" style="transition: stroke-dashoffset 1.5s ease-out;"/>
            </svg>
            <div class="relative w-full h-full flex flex-col items-center justify-center mt-[-10px]">
                <span class="text-white text-2xl font-bold" id="velocityScoreText">0</span>
                <span class="text-white text-[8px] opacity-80 -mt-1">Velocity</span>
                <span id="velocityScoreChange" class="score-change"></span>
            </div>
        </div>
        
        <div id="home-buttons-container" class="absolute bottom-6 left-1/2 -translate-x-1/2 flex flex-col items-center space-y-3 z-20">
             <div class="flex space-x-3">
                <button id="saveMoneyBtn" class="bg-[#ee9b00] text-[#004d40] font-bold py-3 px-6 rounded-full flex items-center space-x-2 shadow-lg hover:bg-amber-500 transition-all duration-300">
                     <i class="fas fa-piggy-bank"></i> <span>Save for Goal</span>
                </button>
                <button id="whatIfBtn" class="bg-white/20 backdrop-blur-md text-white font-semibold py-3 px-5 rounded-full flex items-center space-x-2 shadow-lg hover:bg-white/30 transition-all duration-300">
                    <i class="fas fa-compass"></i> <span>What If?</span>
                </button>
            </div>
            <button id="upgradeBoatBtn" class="hidden bg-green-500 text-white font-bold py-2 px-4 rounded-full upgrade-boat-btn">
                <i class="fas fa-arrow-up"></i> Upgrade Your Boat!
            </button>
        </div>

        <section id="history-section" class="absolute top-0 right-0 h-full w-full max-w-md bg-white/90 backdrop-blur-lg p-6 flex flex-col z-40 overflow-y-auto transform translate-x-full transition-transform duration-500 ease-in-out">
             <div class="flex justify-between items-center mb-4 sticky top-0 bg-white/90 py-4 -mt-6 -mx-6 px-6 shadow-sm">
                <h2 class="text-xl font-bold text-[#004d40]">Transaction History</h2>
                <button id="ghostToggle" class="hidden text-xs bg-sky-100 text-sky-700 px-3 py-1.5 rounded-full font-semibold">Show Comparison</button>
            </div>
            <div id="transactionList" class="space-y-4 flex-grow"></div>
        </section>

        <section id="profile-section" class="absolute top-0 right-0 h-full w-full max-w-md bg-white/90 backdrop-blur-lg p-6 flex-col z-40 overflow-y-auto transform translate-x-full transition-transform duration-500 ease-in-out hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-[#004d40]">My Profile</h2>
            </div>
            <div class="text-center">
                <img src="https://i.ibb.co/6n20s3B/pirate-captain-avatar.png" alt="User Avatar" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                <h3 id="profileName" class="text-2xl font-bold text-gray-800">Captain Sparrow</h3>
                <p id="profileEmail" class="text-gray-500">captain.sparrow@sea.com</p>
            </div>
            <div class="mt-8">
                <button id="editProfileBtn" class="w-full bg-[#ee9b00] text-[#004d40] font-bold py-3 px-5 rounded-lg flex items-center justify-center space-x-3 hover:bg-amber-500 transition-colors">
                    <i class="fas fa-edit"></i>
                    <span>Edit Profile</span>
                </button>
            </div>
        </section>

        <nav class="absolute top-1/2 -translate-y-1/2 left-0 bg-white/90 backdrop-blur-lg flex flex-col space-y-6 p-3 z-50 shadow-lg rounded-r-2xl">
             <a href="#" id="homeNav" class="flex flex-col items-center text-[#ee9b00] w-16">
                <i class="fas fa-ship text-2xl mb-1"></i><span class="text-xs font-bold">Home</span>
            </a>
            <a href="#" id="historyNav" class="flex flex-col items-center text-gray-500 hover:text-[#ee9b00] w-16 transition-colors">
                <i class="fas fa-history text-2xl mb-1"></i><span class="text-xs">History</span>
            </a>
            <a href="#" id="sendNav" class="flex flex-col items-center text-gray-500 hover:text-[#ee9b00] w-16 transition-colors">
                <i class="fas fa-paper-plane text-2xl mb-1"></i><span class="text-xs">Send</span>
            </a>
            <a href="#" id="profileNav" class="flex flex-col items-center text-gray-500 hover:text-[#ee9b00] w-16 transition-colors">
                <i class="fas fa-user-circle text-2xl mb-1"></i><span class="text-xs">Profile</span>
            </a>
        </nav>
    </main>
    
    <div id="whatIfModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6">
            <h3 class="text-xl font-bold text-[#004d40] mb-4">Chart a New Course</h3>
            <div class="space-y-4">
                <div>
                    <label for="simType" class="block text-sm font-medium text-gray-700">Type of Change</label>
                    <select id="simType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md">
                        <option value="INCREASE_SAVINGS">Increase Savings</option>
                        <option value="CUT_SPENDING">Cut Spending</option>
                    </select>
                </div>

                 <div>
                    <label for="simCategory" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="simCategory" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md">
                        <option value="Entertainment">Entertainment</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Restaurant">Restaurant</option>
                        
                    </select>
                </div>
                <div>
                    <label for="simAmount" class="block text-sm font-medium text-gray-700">Monthly Amount (₹)</label>
                    <input type="number" id="simAmount" placeholder="5000" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeWhatIfModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="runSimulationBtn" class="bg-[#ee9b00] text-[#004d40] font-bold px-4 py-2 rounded-lg hover:bg-amber-500">Analyze</button>
            </div>
        </div>
    </div>
    
    <div id="saveMoneyModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6">
            <h3 class="text-xl font-bold text-[#004d40] mb-4">Save Towards Goal</h3>
            <p class="text-sm text-gray-600 mb-4">How much would you like to transfer to your savings cargo?</p>
            <div>
                <label for="saveAmount" class="block text-sm font-medium text-gray-700">Amount to Save (₹)</label>
                <input type="number" id="saveAmount" placeholder="1000" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeSaveMoneyModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmSaveMoneyBtn" class="bg-[#ee9b00] text-[#004d40] font-bold px-4 py-2 rounded-lg hover:bg-amber-500">Confirm Savings</button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6 text-center">
            <h3 class="text-xl font-bold text-[#004d40] mb-2">Manage Total Balance</h3>
            <p class="text-sm text-gray-600 mb-6">Add or send funds from your total balance.</p>
            <div class="space-y-4">
                <button id="modalAddBalanceBtn" class="w-full bg-green-500 text-white font-bold py-3 px-5 rounded-lg flex items-center justify-center space-x-3 hover:bg-green-600 transition-colors">
                    <i class="fas fa-plus-circle fa-lg"></i>
                    <span>Add Cargo to Balance</span>
                </button>
                <button id="modalSendCargoBtn" class="w-full bg-sky-500 text-white font-bold py-3 px-5 rounded-lg flex items-center justify-center space-x-3 hover:bg-sky-600 transition-colors">
                    <i class="fas fa-paper-plane fa-lg"></i>
                    <span>Send Cargo from Balance</span>
                </button>
            </div>
            <div class="mt-6">
                <button id="closeActionModal" class="text-gray-500 hover:text-gray-700">Close</button>
            </div>
        </div>
    </div>

    <div id="addBalanceModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6">
            <h3 class="text-xl font-bold text-[#004d40] mb-4">Add to Total Balance</h3>
            <p class="text-sm text-gray-600 mb-4">This will add funds to your main balance, not the savings goal.</p>
            <div>
                <label for="addBalanceAmount" class="block text-sm font-medium text-gray-700">Amount to Add (₹)</label>
                <input type="number" id="addBalanceAmount" placeholder="5000" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeAddBalanceModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmAddBalanceBtn" class="bg-[#ee9b00] text-[#004d40] font-bold px-4 py-2 rounded-lg hover:bg-amber-500">Confirm Deposit</button>
            </div>
        </div>
    </div>

    <div id="sendCargoModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6">
            <h3 class="text-xl font-bold text-[#004d40] mb-4">Send Cargo (Expense)</h3>
            <div class="space-y-4">
                <div>
                    <label for="sendRecipient" class="block text-sm font-medium text-gray-700">Recipient</label>
                    <input type="text" id="sendRecipient" placeholder="e.g., Landlord, Friend" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="sendCategory" class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="sendCategory" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md">
                        <option>Bills</option>
                        <option>Groceries</option>
                        <option>Friends</option>
                        <option>Shopping</option>
                        <option>Entertainment</option>
                    </select>
                </div>
                <div>
                    <label for="sendAmount" class="block text-sm font-medium text-gray-700">Amount to Send (₹)</label>
                    <input type="number" id="sendAmount" placeholder="1000" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeSendCargoModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmSendBtn" class="bg-[#ee9b00] text-[#004d40] font-bold px-4 py-2 rounded-lg hover:bg-amber-500">Confirm Send</button>
            </div>
        </div>
    </div>
    
    <div id="profileModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6">
            <h3 class="text-xl font-bold text-[#004d40] mb-4">Edit Profile</h3>
            <div class="space-y-4">
                <div>
                    <label for="editName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="editName" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="editEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="editEmail" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeProfileModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="saveProfileBtn" class="bg-[#ee9b00] text-[#004d40] font-bold px-4 py-2 rounded-lg hover:bg-amber-500">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="withdrawSavingsModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6">
            <h3 class="text-xl font-bold text-[#004d40] mb-2">Emergency Withdrawal</h3>
            <p class="text-sm text-gray-600 mb-4">Take from your saved cargo. This will be moved to your total balance.</p>
            <div class="text-center bg-gray-100 p-3 rounded-lg mb-4">
                <p class="text-sm text-gray-500">Currently Saved in Cargo</p>
                <p id="withdrawModalSavingsAmount" class="text-2xl font-bold text-[#004d40]"></p>
            </div>
            <div>
                <label for="withdrawAmount" class="block text-sm font-medium text-gray-700">Amount to Withdraw (₹)</label>
                <input type="number" id="withdrawAmount" placeholder="500" class="mt-1 focus:ring-amber-500 focus:border-amber-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="closeWithdrawModal" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmWithdrawBtn" class="bg-red-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-red-600">Withdraw</button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-hidden">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-11/12 max-w-sm p-6 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-amber-400 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Are you sure?</h3>
            <p id="confirmationMessage" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelConfirmBtn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="finalConfirmBtn" class="bg-red-500 text-white font-bold px-6 py-2 rounded-lg hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>


<script>
    let totalBalance = 124580.75;
    let currentSavings = 0;
    let savingsGoal = 15000;
    let boatLevel = 0; 

    let originalTimeline = [
        { icon: 'fa-utensils', color: 'teal', title: 'The Salty Siren', category: 'Restaurant', amount: -1250.00, type: 'debit' },
        { icon: 'fa-anchor', color: 'sky', title: 'Portside Supplies', category: 'Shopping', amount: -4800.50, type: 'debit' },
        { icon: 'fa-treasure-chest', color: 'emerald', title: 'Monthly Bounty', category: 'Salary', amount: 85000.00, type: 'credit' },
        { icon: 'fa-film', color: 'purple', title: 'Cinema Seas', category: 'Entertainment', amount: -750.00, type: 'debit' },
    ];
    let activeTimeline = JSON.parse(JSON.stringify(originalTimeline));
    let ghostTimeline = null;

    const historySection = document.getElementById('history-section');
    const profileSection = document.getElementById('profile-section');
    const currentSavingsEl = document.getElementById('currentSavings');
    const savingsGoalEl = document.getElementById('savingsGoal');
    const savingsProgressBar = document.getElementById('savingsProgressBar');
    const upgradeBoatBtn = document.getElementById('upgradeBoatBtn');
    const transactionListEl = document.getElementById('transactionList');
    const ghostToggleBtn = document.getElementById('ghostToggle');
    const balanceLockerBtn = document.getElementById('balanceLockerBtn');
    const saveMoneyBtn = document.getElementById('saveMoneyBtn');
    const navLinks = { 
        home: document.getElementById('homeNav'), 
        history: document.getElementById('historyNav'),
        send: document.getElementById('sendNav'),
        profile: document.getElementById('profileNav') 
    };
    const homeUIElements = [
        document.querySelector('header'),
        document.getElementById('velocityScoreGauge'),
        document.getElementById('home-buttons-container')
    ];
    const oceanCanvas = document.getElementById('oceanCanvas');
    
    let scene, camera, renderer, ocean, boat, basicBoat, premiumBoat, pirateKingBoat, clock, savingsCargo, controls, cubeCamera, sun, raycaster, mouse;
    const container = document.querySelector('main');
    
    function init3D() {
        scene = new THREE.Scene();
        renderer = new THREE.WebGLRenderer({ canvas: oceanCanvas, antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight); 
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;

        camera = new THREE.PerspectiveCamera(55, container.clientWidth / container.clientHeight, 1, 20000);
        camera.position.set(0, 5, 12);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

        const sky = new THREE.Sky();
        sky.scale.setScalar(10000);
        scene.add(sky);

        sun = new THREE.Vector3();
        const effectController = {
            turbidity: 10,
            rayleigh: 2,
            mieCoefficient: 0.005,
            mieDirectionalG: 0.8,
            elevation: 2,
            azimuth: 180,
            exposure: renderer.toneMappingExposure
        };

        const uniforms = sky.material.uniforms;
        uniforms[ 'turbidity' ].value = effectController.turbidity;
        uniforms[ 'rayleigh' ].value = effectController.rayleigh;
        uniforms[ 'mieCoefficient' ].value = effectController.mieCoefficient;
        uniforms[ 'mieDirectionalG' ].value = effectController.mieDirectionalG;

        const phi = THREE.MathUtils.degToRad( 90 - effectController.elevation );
        const theta = THREE.MathUtils.degToRad( effectController.azimuth );

        sun.setFromSphericalCoords( 1, phi, theta );
        uniforms[ 'sunPosition' ].value.copy( sun );
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
        directionalLight.position.set(sun.x * 100, sun.y * 100, sun.z * 100);
        scene.add(directionalLight);

        
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.minDistance = 5;
        controls.maxDistance = 20;
        controls.maxPolarAngle = Math.PI / 2 - 0.05;
        
        const cubeRenderTarget = new THREE.WebGLCubeRenderTarget( 256, {
            format: THREE.RGBFormat,
            generateMipmaps: true,
            minFilter: THREE.LinearMipmapLinearFilter
        } );
        cubeCamera = new THREE.CubeCamera( 1, 1000, cubeRenderTarget );
        
        clock = new THREE.Clock();
        createOcean();
        createAllBoats(cubeRenderTarget.texture);
        createSavingsCargo();
        window.addEventListener('resize', onWindowResize);
        oceanCanvas.addEventListener('click', onCanvasClick);
        animate3D();
    }
    
    function onCanvasClick(event) {
        event.preventDefault();

        mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
        mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(boat.children, true);

        if (intersects.length > 0 && currentSavings > 0) {
            document.getElementById('withdrawModalSavingsAmount').textContent = formatCurrency(currentSavings);
            showModal(modals.withdrawSavings);
        }
    }

    function createAllBoats(envMap) {
        boat = new THREE.Group();
        
        basicBoat = new THREE.Group();
        const woodMaterial = new THREE.MeshStandardMaterial({
            color: 0x8B5A2B,
            roughness: 0.3,
            metalness: 0.2,
            envMap: envMap,
            side: THREE.DoubleSide
        });

        const hullGeometry = new THREE.SphereGeometry(2.5, 16, 8, 0, Math.PI * 2, 0, Math.PI / 2);
        const positions = hullGeometry.attributes.position;
        const vertex = new THREE.Vector3();

        for (let i = 0; i < positions.count; i++) {
            vertex.fromBufferAttribute(positions, i);
            vertex.z *= 2.0; 
            if (vertex.y < 0) { vertex.y *= 0.2;}
            vertex.y += 0.5;
            if (vertex.z > 0) { vertex.x *= Math.max(0, 1 - vertex.z / 4); }
            if (vertex.z < -3.5) { vertex.z = -3.5; }
            positions.setXYZ(i, vertex.x, vertex.y, vertex.z);
        }
        hullGeometry.computeVertexNormals();
        const hull = new THREE.Mesh(hullGeometry, woodMaterial);
        hull.rotation.x = Math.PI;
        hull.scale.set(0.8, 0.8, 0.8);
        basicBoat.add(hull);

        const floor = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.1, 4), woodMaterial);
        floor.position.y = 0.2;
        basicBoat.add(floor);

        const seatMaterial = new THREE.MeshStandardMaterial({ color: 0x9d6b53, roughness: 0.8, envMap: envMap });
        const sternSeat = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.1, 0.8), seatMaterial);
        sternSeat.position.set(0, 0.7, -1.5);
        const midSeat = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.1, 0.8), seatMaterial);
        midSeat.position.set(0, 0.7, 0);
        const bowSeat = new THREE.Mesh(new THREE.BoxGeometry(1, 0.1, 0.8), seatMaterial);
        bowSeat.position.set(0, 0.7, 1.5);
        basicBoat.add(sternSeat, midSeat, bowSeat);
        
        const oarMaterial = new THREE.MeshStandardMaterial({ color: 0x5C4033, roughness: 0.9, envMap: envMap });
        const oarHandle = new THREE.CylinderGeometry(0.05, 0.05, 3, 8);
        const oarPaddle = new THREE.BoxGeometry(0.3, 0.05, 0.8);
        const oar1 = new THREE.Group();
        const handle1 = new THREE.Mesh(oarHandle, oarMaterial);
        const paddle1 = new THREE.Mesh(oarPaddle, oarMaterial);
        paddle1.position.y = -1.4;
        oar1.add(handle1, paddle1);
        oar1.position.set(-0.8, 0.8, 0);
        oar1.rotation.z = Math.PI / 6;
        oar1.rotation.y = -Math.PI / 12;
        const oar2 = oar1.clone();
        oar2.position.x = 0.8;
        oar2.rotation.z = -Math.PI / 6;

        basicBoat.add(oar1, oar2);
        boat.add(basicBoat);
        boat.position.y = 0;
        
        premiumBoat = new THREE.Group();
        premiumBoat.visible = false;
        const premiumWoodMaterial = new THREE.MeshStandardMaterial({ color: 0x4a2c2a, roughness: 0.4, metalness: 0.3, transparent: true, opacity: 0, envMap: envMap });
        const premiumSailMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0 });
        const premiumHullMain = new THREE.Mesh(new THREE.BoxGeometry(4, 0.8, 1.2), premiumWoodMaterial);
        premiumHullMain.position.y = 0.2;
        const premiumHullBow = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 0.8, 8, 1, false, 0, Math.PI), premiumWoodMaterial);
        premiumHullBow.rotation.set(Math.PI/2, Math.PI/2, 0);
        premiumHullBow.position.set(-2, 0.2, 0);
        const premiumHullStern = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 1.2), premiumWoodMaterial);
        premiumHullStern.position.set(1.5, 0.4, 0);
        const mainMast = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 4, 12), premiumWoodMaterial);
        mainMast.position.set(0.5, 2, 0);
        const foreMast = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 3, 12), premiumWoodMaterial);
        foreMast.position.set(-1.2, 1.5, 0);
        const mainSail = new THREE.Mesh(new THREE.PlaneGeometry(2, 2.5), premiumSailMaterial);
        mainSail.position.set(0.5, 2.5, 0);
        const foreSail = new THREE.Mesh(new THREE.PlaneGeometry(1.5, 2), premiumSailMaterial);
        foreSail.position.set(-1.2, 2, 0);
        premiumBoat.add(premiumHullMain, premiumHullBow, premiumHullStern, mainMast, foreMast, mainSail, foreSail);
        boat.add(premiumBoat);

        pirateKingBoat = new THREE.Group();
        pirateKingBoat.visible = false;
        const pirateWoodMaterial = new THREE.MeshStandardMaterial({ color: 0x211717, roughness: 0.5, metalness: 0.2, transparent: true, opacity: 0, envMap: envMap });
        const pirateSailMaterial = new THREE.MeshStandardMaterial({ color: 0x111111, side: THREE.DoubleSide, transparent: true, opacity: 0 });
        const silverMaterial = new THREE.MeshStandardMaterial({color: 0xc0c0c0, metalness: 0.9, roughness: 0.2, transparent: true, opacity: 0, envMap: envMap});
        
        const pirateHull = premiumHullMain.clone();
        pirateHull.material = pirateWoodMaterial;
        pirateHull.scale.set(1.2, 1.2, 1.2);
        const pirateBow = premiumHullBow.clone();
        pirateBow.material = pirateWoodMaterial;
        pirateBow.position.x = -2.4;
        const pirateStern = premiumHullStern.clone();
        pirateStern.material = pirateWoodMaterial;
        pirateStern.scale.set(1.1, 1.1, 1.1);
        pirateStern.position.x = 1.8;
        
        const pirateMainMast = mainMast.clone();
        pirateMainMast.material = pirateWoodMaterial;
        pirateMainMast.scale.y = 1.2;
        pirateMainMast.position.y = 2.4;
        const pirateForeMast = foreMast.clone();
        pirateForeMast.material = pirateWoodMaterial;
        const mizzenMast = foreMast.clone();
        mizzenMast.scale.y = 0.8;
        mizzenMast.position.set(1.5, 1.2, 0);

        const pirateMainSail = mainSail.clone();
        pirateMainSail.material = pirateSailMaterial;
        const pirateForeSail = foreSail.clone();
        pirateForeSail.material = pirateSailMaterial;
        const mizzenSail = new THREE.Mesh(new THREE.PlaneGeometry(1.2, 1.6), pirateSailMaterial);
        mizzenSail.position.set(1.5, 1.6, 0);
        
        const silverFigurehead = new THREE.Mesh(new THREE.ConeGeometry(0.25, 1, 8), silverMaterial);
        silverFigurehead.rotation.z = -Math.PI / 2.5;
        silverFigurehead.position.set(-2.9, 0.5, 0);

        pirateKingBoat.add(pirateHull, pirateBow, pirateStern, pirateMainMast, pirateForeMast, mizzenMast, pirateMainSail, pirateForeSail, mizzenSail, silverFigurehead);
        boat.add(pirateKingBoat);

        scene.add(boat);
    }
    
    function upgradeBoat() {
        let currentBoat, nextBoat;
        if (boatLevel === 0) {
            currentBoat = basicBoat;
            nextBoat = premiumBoat;
            savingsGoal = 50000;
        } else if (boatLevel === 1) {
            currentBoat = premiumBoat;
            nextBoat = pirateKingBoat;
            savingsGoal = 100000; 
        } else {
            return; 
        }

        const fadeDuration = 1.5;
        const startTimestamp = clock.getElapsedTime();
        
        function fade() {
            const elapsed = clock.getElapsedTime() - startTimestamp;
            const progress = Math.min(elapsed / fadeDuration, 1);
            
            currentBoat.traverse(child => { if (child.material) child.material.opacity = 1 - progress; });
            nextBoat.visible = true;
            nextBoat.traverse(child => { if (child.material) child.material.opacity = progress; });
            
            if (progress < 1) {
                requestAnimationFrame(fade);
            } else {
                currentBoat.visible = false;
            }
        }
        fade();
        
        boatLevel++;
        currentSavings = 0;
        updateUIState();
        upgradeBoatBtn.classList.add('hidden');
    }

    function createSavingsCargo() {
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const material = new THREE.MeshStandardMaterial({ color: 0xfca5a5, roughness: 0.6, metalness: 0.3 });
        savingsCargo = new THREE.Mesh(geometry, material);
        savingsCargo.position.y = 0.5;
        savingsCargo.visible = false;
        boat.add(savingsCargo);
    }

    function updateUIState() {
        const percentage = Math.min((currentSavings / savingsGoal) * 100, 100);
        savingsProgressBar.style.width = `${percentage}%`;
        currentSavingsEl.dataset.amount = currentSavings;
        savingsGoalEl.dataset.amount = savingsGoal;
        document.querySelector('header .monetary-value').dataset.amount = totalBalance; // Update total balance in header
        updateAllMonetaryValues();

        const savingsRatio = Math.min(currentSavings / savingsGoal, 2);
        if (savingsRatio > 0) {
            savingsCargo.visible = true;
            const scale = 0.5 + savingsRatio * 0.8;
            savingsCargo.scale.set(scale, scale, scale);
            savingsCargo.position.y = 0.3 + (scale * 0.8 / 2);
            oceanCanvas.classList.add('boat-clickable');
        } else {
            savingsCargo.visible = false;
            oceanCanvas.classList.remove('boat-clickable');
        }
        const canUpgrade = (boatLevel === 0 && currentSavings >= 15000) || (boatLevel === 1 && currentSavings >= 50000);
        upgradeBoatBtn.classList.toggle('hidden', !canUpgrade);
    }

    function createOcean() {
        const waterGeometry = new THREE.PlaneGeometry( 10000, 10000 );
        ocean = new THREE.Water(
            waterGeometry,
            {
                textureWidth: 512,
                textureHeight: 512,
                waterNormals: new THREE.TextureLoader().load( 'https://threejs.org/examples/textures/waternormals.jpg', function ( texture ) {
                    texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                }),
                sunDirection: new THREE.Vector3(),
                sunColor: 0xffffff,
                waterColor: 0x001e0f,
                distortionScale: 3.7,
                fog: scene.fog !== undefined
            }
        );
        ocean.rotation.x = - Math.PI / 2;
        scene.add(ocean);
    }
    
    function onWindowResize() {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }

    function animate3D() {
        requestAnimationFrame(animate3D);
        const elapsedTime = clock.getElapsedTime();
        
        ocean.material.uniforms[ 'time' ].value += 1.0 / 60.0;
        
        const boatY = 0.1 * Math.sin(elapsedTime * 1.5);
        boat.position.y = 0 + boatY;
        boat.rotation.y = 0.02 * Math.cos(elapsedTime * 0.8);
        
        boat.visible = false;
        cubeCamera.position.copy(boat.position);
        cubeCamera.update(renderer, scene);
        boat.visible = true;

        controls.update();
        renderer.render(scene, camera);
    }

    function calculateVelocityScore(timeline) {
        if (!timeline || timeline.length === 0) return 0;
        let totalIncome = timeline.filter(tx => tx.type === 'credit').reduce((sum, tx) => sum + tx.amount, 0);
        let totalSpending = timeline.filter(tx => tx.type === 'debit').reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
        let wantsSpending = timeline.filter(tx => ['Restaurant', 'Shopping', 'Entertainment', 'Friends'].includes(tx.category)).reduce((sum, tx) => sum + Math.abs(tx.amount), 0);
        const incomeScore = Math.min((totalIncome / 100000) * 500, 500);
        const efficiencyScore = 500 * (1 - (totalSpending > 0 ? wantsSpending / totalSpending : 0));
        return Math.round(Math.max(0, Math.min(incomeScore + efficiencyScore, 1000)));
    }

    function updateVelocityScoreUI(newScore, oldScore) {
        document.getElementById('velocityScoreText').textContent = newScore;
        document.getElementById('velocityScoreBar').style.strokeDashoffset = 125.6 * (1 - (newScore / 1000));
        if (oldScore !== null) {
            const change = newScore - oldScore;
            if (change !== 0) {
                const scoreChangeEl = document.getElementById('velocityScoreChange');
                scoreChangeEl.textContent = `${change > 0 ? '+' : ''}${change}`;
                scoreChangeEl.className = 'score-change';
                void scoreChangeEl.offsetWidth;
                scoreChangeEl.classList.add('show', change > 0 ? 'text-green-400' : 'text-red-400');
            }
        }
    }

    const formatCurrency = (amount) => `₹${Math.abs(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    const updateAllMonetaryValues = () => document.querySelectorAll('.monetary-value').forEach(el => el.textContent = formatCurrency(parseFloat(el.dataset.amount)));
    
    const createTransactionHTML = (transaction, isGhost = false) => `
        <div class="flex items-center p-3 rounded-xl bg-white/70 transaction-item ${isGhost ? 'ghost-timeline' : ''}">
            <div class="w-10 h-10 bg-${transaction.color}-100 rounded-full flex items-center justify-center mr-4"><i class="fas ${transaction.icon} text-${transaction.color}-600"></i></div>
            <div class="flex-grow"><p class="font-semibold text-gray-800">${transaction.title}</p><p class="text-sm text-gray-500">${transaction.category}</p></div>
            <p class="font-bold ${transaction.type === 'debit' ? 'text-red-500' : 'text-green-500'}">${transaction.type === 'debit' ? '-' : '+'} <span class="monetary-value" data-amount="${Math.abs(transaction.amount)}"></span></p>
        </div>`;

    const renderTransactions = () => {
        transactionListEl.innerHTML = activeTimeline.map(tx => createTransactionHTML(tx)).join('');
        if (ghostTimeline && ghostToggleBtn.classList.contains('bg-sky-700')) {
             transactionListEl.innerHTML += ghostTimeline.map(tx => createTransactionHTML(tx, true)).join('');
        }
        updateAllMonetaryValues();
    };
    
    const setActivePage = (pageName) => {
        const isHome = pageName === 'home';
        const isHistory = pageName === 'history';
        const isProfile = pageName === 'profile';

        historySection.classList.toggle('translate-x-full', !isHistory);
        profileSection.classList.toggle('hidden', !isProfile);
        profileSection.classList.toggle('flex', isProfile);
        profileSection.classList.toggle('translate-x-full', !isProfile);
        
        homeUIElements.forEach(el => el.style.display = isHome ? '' : 'none');
        if (isHome) document.querySelector('header').style.display = 'flex';

        Object.keys(navLinks).forEach(key => {
            navLinks[key].classList.toggle('text-[#ee9b00]', key === pageName);
            navLinks[key].classList.toggle('text-gray-500', key !== pageName);
        });

        if (isHistory) renderTransactions();
    };


    navLinks.home.addEventListener('click', (e) => { e.preventDefault(); setActivePage('home'); });
    navLinks.history.addEventListener('click', (e) => { e.preventDefault(); setActivePage('history'); });
    navLinks.profile.addEventListener('click', (e) => { e.preventDefault(); setActivePage('profile'); });

    const modals = {
        whatIf: document.getElementById('whatIfModal'),
        saveMoney: document.getElementById('saveMoneyModal'),
        action: document.getElementById('actionModal'),
        addBalance: document.getElementById('addBalanceModal'),
        sendCargo: document.getElementById('sendCargoModal'),
        profile: document.getElementById('profileModal'),
        withdrawSavings: document.getElementById('withdrawSavingsModal'),
        confirmation: document.getElementById('confirmationModal')
    };
    const showModal = (modal) => modal.classList.remove('modal-hidden');
    const hideModal = (modal) => modal.classList.add('modal-hidden');

    let confirmAction = null;

    document.getElementById('whatIfBtn').addEventListener('click', () => showModal(modals.whatIf));
    document.getElementById('saveMoneyBtn').addEventListener('click', () => showModal(modals.saveMoney));
    balanceLockerBtn.addEventListener('click', () => showModal(modals.action));
    document.getElementById('modalAddBalanceBtn').addEventListener('click', () => { hideModal(modals.action); showModal(modals.addBalance); });
    document.getElementById('modalSendCargoBtn').addEventListener('click', () => { hideModal(modals.action); showModal(modals.sendCargo); });
    document.getElementById('editProfileBtn').addEventListener('click', () => {
        document.getElementById('editName').value = document.getElementById('profileName').textContent;
        document.getElementById('editEmail').value = document.getElementById('profileEmail').textContent;
        showModal(modals.profile);
    });

    Object.values(modals).forEach(modal => {
        const closeButton = modal.querySelector('[id^="close"], [id^="cancel"]');
        if (closeButton) closeButton.addEventListener('click', () => hideModal(modal));
    });
    
    document.getElementById('confirmSaveMoneyBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('saveAmount').value);
        if (!isNaN(amount) && amount > 0 && totalBalance >= amount) {
            totalBalance -= amount;
            currentSavings += amount;
            originalTimeline.unshift({ icon: 'fa-piggy-bank', color: 'pink', title: 'Saved to Cargo', category: 'Savings', amount: -amount, type: 'debit' });
            activeTimeline = [...originalTimeline];
            updateUIState();
        }
        document.getElementById('saveAmount').value = '';
        hideModal(modals.saveMoney);
    });

    document.getElementById('confirmAddBalanceBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('addBalanceAmount').value);
        if (!isNaN(amount) && amount > 0) {
            totalBalance += amount;
            originalTimeline.unshift({ icon: 'fa-plus-circle', color: 'green', title: 'Funds Added', category: 'Deposit', amount: amount, type: 'credit' });
            activeTimeline = [...originalTimeline];
            updateUIState();
        }
        document.getElementById('addBalanceAmount').value = '';
        hideModal(modals.addBalance);
    });
    
    document.getElementById('confirmSendBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('sendAmount').value);
        const recipient = document.getElementById('sendRecipient').value;
        const category = document.getElementById('sendCategory').value;
        
        if (!isNaN(amount) && amount > 0 && totalBalance >= amount && recipient) {
            const oldScore = calculateVelocityScore(activeTimeline);
            totalBalance -= amount;
            
            const newTransaction = { icon: 'fa-paper-plane', color: 'sky', title: `Sent to ${recipient}`, category: category, amount: -amount, type: 'debit' };
            originalTimeline.unshift(newTransaction);
            activeTimeline = [...originalTimeline];
            
            updateUIState();
            const newScore = calculateVelocityScore(activeTimeline);
            updateVelocityScoreUI(newScore, oldScore);
        }
        
        document.getElementById('sendAmount').value = '';
        document.getElementById('sendRecipient').value = '';
        hideModal(modals.sendCargo);
    });
    
    document.getElementById('saveProfileBtn').addEventListener('click', () => {
        const newName = document.getElementById('editName').value;
        const newEmail = document.getElementById('editEmail').value;
        if (newName) document.getElementById('profileName').textContent = newName;
        if (newEmail) document.getElementById('profileEmail').textContent = newEmail;
        hideModal(modals.profile);
    });

    document.getElementById('confirmWithdrawBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('withdrawAmount').value);
        if (isNaN(amount) || amount <= 0 || amount > currentSavings) {
            alert("Please enter a valid amount to withdraw.");
            return;
        }
        
        document.getElementById('confirmationMessage').textContent = `Are you sure you want to withdraw ${formatCurrency(amount)} from your saved cargo?`;
        
        confirmAction = () => {
            currentSavings -= amount;
            totalBalance += amount;
            
            originalTimeline.unshift({ icon: 'fa-hand-holding-usd', color: 'orange', title: 'Withdrew from Cargo', category: 'Savings Withdrawal', amount: amount, type: 'credit' });
            activeTimeline = [...originalTimeline];
            
            updateUIState();
            hideModal(modals.withdrawSavings);
            document.getElementById('withdrawAmount').value = '';
        };

        showModal(modals.confirmation);
    });
    
    document.getElementById('finalConfirmBtn').addEventListener('click', () => {
        if (typeof confirmAction === 'function') {
            confirmAction();
            confirmAction = null;
        }
        hideModal(modals.confirmation);
    });
    
    document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
        confirmAction = null;
        hideModal(modals.confirmation);
    });


    upgradeBoatBtn.addEventListener('click', upgradeBoat);

    document.getElementById('runSimulationBtn').addEventListener('click', () => {
        const oldScore = calculateVelocityScore(activeTimeline);
        ghostTimeline = [...activeTimeline];
        const simCategory = document.getElementById('simCategory').value;
        const simAmount = parseFloat(document.getElementById('simAmount').value) || 0;
        const simType = document.getElementById('simType').value;
        let newTimeline = JSON.parse(JSON.stringify(originalTimeline));
        
        if (simType === 'CUT_SPENDING') newTimeline = newTimeline.filter(tx => tx.category !== simCategory);
        else if (simType === 'INCREASE_SAVINGS' && simAmount > 0) newTimeline.unshift({ icon: 'fa-piggy-bank', color: 'pink', title: 'Projected Extra Savings', category: 'Savings', amount: -simAmount, type: 'debit' });
        
        activeTimeline = newTimeline;
        const newScore = calculateVelocityScore(activeTimeline);
        updateVelocityScoreUI(newScore, oldScore);
        hideModal(modals.whatIf);
        ghostToggleBtn.classList.remove('hidden');
        ghostToggleBtn.className = 'text-xs bg-sky-700 text-white px-3 py-1.5 rounded-full font-semibold';
        ghostToggleBtn.textContent = 'Hide Comparison';
        setActivePage('history');
    });

    ghostToggleBtn.addEventListener('click', () => {
        ghostToggleBtn.classList.toggle('bg-sky-700');
        ghostToggleBtn.textContent = ghostToggleBtn.classList.contains('bg-sky-700') ? 'Hide Comparison' : 'Show Comparison';
        renderTransactions();
    });

    document.addEventListener('DOMContentLoaded', () => {
        const waterScript = document.createElement('script');
        waterScript.src = 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/objects/Water.js';
        document.head.appendChild(waterScript);

        waterScript.onload = () => {
            const skyScript = document.createElement('script');
            skyScript.src = 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/objects/Sky.js';
            document.head.appendChild(skyScript);
            
            skyScript.onload = () => {
                 init3D();
                 setActivePage('home');
                 updateUIState();
                 updateVelocityScoreUI(calculateVelocityScore(activeTimeline), null);
            }
        };
    });
</script>
</body>
</html>